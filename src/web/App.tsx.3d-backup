/**
 * ç”µå•†æ™ºèƒ½åŠ©æ‰‹å¹³å° - ä¸»åº”ç”¨
 * Lucid UI - Design Forward Edition
 */

import { useState, useEffect } from "react";
import { Chat, useAgentX, useImages } from "@agentxjs/ui";
import type { AgentInfo } from "../types";
import {
  GuanhuaAgent,
  FashionCEOAgent,
  VideoMasterAgent,
  XiaohongshuWriterAgent,
} from "../agent";

// ============================================
// Design System Tokens (Mapped to Tailwind)
// ============================================

// 1. Rational (Logic/Tech) - Blue/Slate
const THEME_RATIONAL = {
  bg: "bg-sky-50",
  text: "text-sky-700", 
  border: "border-sky-100",
  icon_bg: "bg-sky-100",
  active_indicator: "bg-sky-600"
};

// 2. Sentient (Creative/Human) - Amber/Rose
const THEME_SENTIENT = {
  bg: "bg-amber-50",
  text: "text-amber-700",
  border: "border-amber-100",
  icon_bg: "bg-amber-100",
  active_indicator: "bg-amber-500"
};

// 3. Expressive (Marketing/Visual) - Rose/Pink (Subtle)
const THEME_EXPRESSIVE = {
  bg: "bg-rose-50",
  text: "text-rose-700",
  border: "border-rose-100",
  icon_bg: "bg-rose-100",
  active_indicator: "bg-rose-500"
};

type Agent = AgentInfo & { theme: typeof THEME_RATIONAL };

// ============================================
// Configuration
// ============================================

const AGENTS_UI: Agent[] = [
  {
    id: "guanhua",
    name: "å† å",
    description: "æ¢å›¾ä¸è§†è§‰ä¼˜åŒ–ä¸“å®¶",
    icon: "ğŸ¨",
    color: "", // Unused, using theme
    theme: THEME_RATIONAL
  },
  {
    id: "fashion-ceo",
    name: "æ—¶å°šCEO",
    description: "å“ç‰Œæˆ˜ç•¥ä¸ç»è¥é¡¾é—®",
    icon: "ğŸ‘”",
    color: "",
    theme: { ...THEME_RATIONAL, icon_bg: "bg-slate-100", text: "text-slate-700", active_indicator: "bg-slate-600" } // More serious
  },
  {
    id: "video-master",
    name: "å‰ªè¾‘å¤§å¸ˆ",
    description: "çŸ­è§†é¢‘å†…å®¹åˆ¶ä½œ",
    icon: "ğŸ¬",
    color: "",
    theme: THEME_SENTIENT
  },
  {
    id: "xiaohongshu-writer",
    name: "ç§è‰è¾¾äºº",
    description: "çˆ†æ¬¾æ–‡æ¡ˆåˆ›ä½œ",
    icon: "ğŸ“",
    color: "",
    theme: THEME_EXPRESSIVE
  },
];

const AGENTS_MAP: Record<string, Agent & { systemPrompt: string }> = {
  "guanhua": { ...AGENTS_UI[0], systemPrompt: GuanhuaAgent.systemPrompt },
  "fashion-ceo": { ...AGENTS_UI[1], systemPrompt: FashionCEOAgent.systemPrompt },
  "video-master": { ...AGENTS_UI[2], systemPrompt: VideoMasterAgent.systemPrompt },
  "xiaohongshu-writer": { ...AGENTS_UI[3], systemPrompt: XiaohongshuWriterAgent.systemPrompt },
};

const PRESET_USERS: Record<string, string> = {
  admin: "admin123",
  demo: "demo123",
};

const WS_URL = `ws://${window.location.hostname}:5800`;

// ============================================
// 3D Scene Components (Light/Air Theme)
// ============================================

function AICore() {
  const meshRef = useRef<THREE.Mesh>(null);
  
  useFrame((state) => {
    if (meshRef.current) {
      meshRef.current.rotation.x = state.clock.getElapsedTime() * 0.2;
      meshRef.current.rotation.y = state.clock.getElapsedTime() * 0.3;
    }
  });

  return (
    <Float speed={2} rotationIntensity={1.5} floatIntensity={2}>
      <mesh ref={meshRef} scale={1.8}>
        <sphereGeometry args={[1, 64, 64]} />
        {/* Ceramic / Pearl White Material */}
        <meshPhysicalMaterial
          color="#ffffff"
          roughness={0.2}
          metalness={0.1}
          clearcoat={0.8}
          clearcoatRoughness={0.1}
          reflectivity={1}
        />
      </mesh>
    </Float>
  );
}

function FloatingData({ position, color, scale = 1 }: { position: [number, number, number], color: string, scale?: number }) {
  const meshRef = useRef<THREE.Mesh>(null);
  
  useFrame(() => {
    if (meshRef.current) {
      meshRef.current.rotation.x += 0.01;
      meshRef.current.rotation.y += 0.02;
    }
  });

  return (
    <Float speed={4} rotationIntensity={2} floatIntensity={1} floatingRange={[-0.2, 0.2]}>
      <mesh ref={meshRef} position={position} scale={scale}>
        <icosahedronGeometry args={[0.3, 0]} />
        <meshStandardMaterial 
          color={color} 
          roughness={0.3}
          metalness={0.5}
          transparent
          opacity={0.9}
        />
      </mesh>
    </Float>
  );
}

function LoginScene() {
  return (
    <>
      <PerspectiveCamera makeDefault position={[0, 0, 6]} fov={50} />
      
      {/* Bright Studio Lighting */}
      <ambientLight intensity={0.8} />
      <directionalLight position={[5, 5, 5]} intensity={1.5} color="#ffffff" castShadow />
      <directionalLight position={[-5, 5, -5]} intensity={1} color="#e0f2fe" />
      <pointLight position={[0, -5, 2]} intensity={0.5} color="#bae6fd" />
      
      {/* Environment Reflections (Studio) */}
      <Environment preset="warehouse" />

      {/* Main Objects */}
      <group position={[0, 0, 0]}>
        <AICore />
        
        {/* Soft Pastel Data Particles */}
        <FloatingData position={[-2, 1.5, -1]} color="#38bdf8" scale={0.6} /> {/* Sky Blue */}
        <FloatingData position={[2, -1, 1]} color="#818cf8" scale={0.5} />  {/* Indigo Soft */}
        <FloatingData position={[1.5, 2, -2]} color="#cbd5e1" scale={0.4} /> {/* Silver */}
        <FloatingData position={[-1.5, -2, 0.5]} color="#94a3b8" scale={0.5} /> {/* Slate */}
      </group>
    </>
  );
}

// ============================================
// Login Page (Modern Bright Design)
// ============================================

function LoginPage({ onLogin }: { onLogin: (userId: string) => void }) {
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    await new Promise(r => setTimeout(r, 800));
    if (PRESET_USERS[username] === password) {
      localStorage.setItem("userId", username);
      localStorage.setItem("authToken", "token");
      onLogin(username);
    } else {
      setError("è´¦å·æˆ–å¯†ç é”™è¯¯");
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen-ios w-full flex bg-white font-sans text-slate-800 selection:bg-blue-100 selection:text-blue-900">
      
      {/* LEFT SIDE: 3D Visual - Clean & Bright */}
      <div className="hidden md:flex w-[45%] bg-gradient-to-br from-slate-50 via-white to-blue-50 relative overflow-hidden flex-col justify-center items-center border-r border-slate-100">
        
        {/* 3D Scene */}
        <div className="absolute inset-0 z-0">
          <Canvas dpr={[1, 2]}>
            <Suspense fallback={null}>
              <LoginScene />
            </Suspense>
          </Canvas>
        </div>

        {/* Overlay Content (Clean Typography) */}
        <div className="relative z-10 w-full max-w-md px-10 text-center pointer-events-none">
          <div className="mb-6 inline-flex items-center justify-center p-4 rounded-3xl bg-white/40 backdrop-blur-xl border border-white/60 shadow-xl shadow-slate-200/50 animate-fade-in-up">
            <span className="text-4xl filter drop-shadow-sm">ğŸ§ </span>
          </div>
          
          <h1 className="text-4xl md:text-5xl font-bold text-slate-900 tracking-tight mb-4 animate-fade-in-up delay-100">
            Agent Intelligence
          </h1>
          
          <p className="text-lg text-slate-500 font-medium leading-relaxed max-w-sm mx-auto animate-fade-in-up delay-200">
            æ¿€æ´»ä½ çš„æ•°å­—å‘˜å·¥ã€‚<br/>
            è®¾è®¡ã€è¥é”€ã€ç­–ç•¥ï¼Œæ™ºèƒ½åä½œã€‚
          </p>
        </div>
      </div>

      {/* RIGHT SIDE: Login Form */}
      <div className="flex-1 flex flex-col items-center justify-center p-8 bg-white relative">
        <div className="w-full max-w-[400px] animate-fade-in">
          
          {/* Logo */}
          <div className="mb-10 text-center md:text-left">
            <div className="w-12 h-12 bg-blue-600 text-white rounded-xl flex items-center justify-center text-2xl font-bold mb-6 shadow-lg shadow-blue-600/20 mx-auto md:mx-0">
              ğŸ›ï¸
            </div>
            <h1 className="text-3xl font-bold text-slate-900 tracking-tight">æ¬¢è¿å›æ¥</h1>
            <p className="text-slate-500 mt-2 text-sm">ç™»å½•ä»¥ç»§ç»­ä½¿ç”¨æ‚¨çš„æ™ºèƒ½ä½“æœåŠ¡ã€‚</p>
          </div>

          {/* Form */}
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="space-y-5">
              <div>
                <label className="block text-sm font-semibold text-slate-700 mb-2">è´¦å· / Email</label>
                <input
                  type="text"
                  value={username}
                  onChange={e => setUsername(e.target.value)}
                  className="w-full h-12 px-4 bg-white border border-slate-200 hover:border-blue-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 rounded-xl text-slate-900 text-base transition-all outline-none shadow-sm placeholder:text-slate-300"
                  placeholder="è¯·è¾“å…¥æ‚¨çš„è´¦å·..."
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-slate-700 mb-2">å¯†ç </label>
                <input
                  type="password"
                  value={password}
                  onChange={e => setPassword(e.target.value)}
                  className="w-full h-12 px-4 bg-white border border-slate-200 hover:border-blue-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 rounded-xl text-slate-900 text-base transition-all outline-none shadow-sm placeholder:text-slate-300"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
              </div>
            </div>

            <div className="flex items-center justify-between text-sm">
              <label className="flex items-center gap-2 cursor-pointer group">
                <input type="checkbox" className="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-600/20 cursor-pointer" />
                <span className="text-slate-500 group-hover:text-slate-700 transition-colors">30å¤©å†…è‡ªåŠ¨ç™»å½•</span>
              </label>
              <a href="#" className="text-blue-600 hover:text-blue-700 font-semibold hover:underline decoration-2 underline-offset-2">å¿˜è®°å¯†ç ?</a>
            </div>

            {error && (
              <div className="p-3 bg-red-50 border border-red-100 text-red-600 text-sm rounded-xl flex items-center gap-2 animate-shake">
                <svg className="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                {error}
              </div>
            )}

            <button
              type="submit"
              disabled={loading}
              className="w-full h-12 bg-blue-600 hover:bg-blue-700 text-white text-base font-semibold rounded-xl shadow-lg shadow-blue-600/20 hover:shadow-blue-600/30 transform active:scale-[0.98] transition-all disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {loading ? (
                <>
                  <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                  ç™»å½•ä¸­...
                </>
              ) : "ç™» å½•"}
            </button>

            {/* Divider */}
            <div className="relative my-8">
              <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-slate-100"></div>
              </div>
              <div className="relative flex justify-center text-xs uppercase tracking-wider">
                <span className="bg-white px-3 text-slate-400 font-medium">å…¶ä»–æ–¹å¼ç™»å½•</span>
              </div>
            </div>

            {/* Social Buttons - Enhanced Visibility */}
            <div className="grid grid-cols-2 gap-4">
              <button type="button" className="h-11 flex items-center justify-center gap-2 bg-white border border-slate-200 hover:border-slate-300 hover:bg-slate-50 rounded-xl transition-all text-sm font-semibold text-slate-700 shadow-sm hover:shadow">
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .533 5.347.533 12S5.867 24 12.48 24c3.44 0 6.04-1.133 8.147-3.253 2.147-2.147 2.813-5.387 2.813-8.24 0-.813-.08-1.587-.227-2.32H12.48z"/></svg>
                Google
              </button>
              <button type="button" className="h-11 flex items-center justify-center gap-2 bg-white border border-slate-200 hover:border-slate-300 hover:bg-slate-50 rounded-xl transition-all text-sm font-semibold text-slate-700 shadow-sm hover:shadow">
                <svg className="w-5 h-5 text-[#1877F2]" viewBox="0 0 24 24" fill="currentColor"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"/></svg>
                Facebook
              </button>
            </div>
          </form>

          {/* Footer Demo Info */}
          <div className="pt-8 text-center">
            <p className="text-xs text-slate-400 bg-slate-50 py-2 px-4 rounded-full inline-block">
              æ¼”ç¤ºè´¦å·: <span className="font-mono text-slate-600 font-bold mx-1">demo</span> å¯†ç : <span className="font-mono text-slate-600 font-bold mx-1">demo123</span>
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================
// Sidebar (PC Only)
// ============================================

function Sidebar({ userId, images, currentImageId, onSelectImage, onNewChat, onDeleteImage, onLogout, isCollapsed, onToggle }: any) {
  return (
    <div className={`${isCollapsed ? 'w-[72px]' : 'w-[280px]'} h-full hidden md:flex flex-col bg-slate-50 border-r border-slate-100 flex-shrink-0 transition-[width] duration-300 ease-[cubic-bezier(0.25,0.1,0.25,1)] relative z-20`}>
      {/* Brand Header & Toggle */}
      <div className={`h-16 flex items-center shrink-0 ${isCollapsed ? 'justify-center px-0' : 'justify-between px-5'}`}>
        <div className={`flex items-center gap-3 transition-opacity duration-200 ${isCollapsed ? '' : 'opacity-100'}`}>
           <div className="w-8 h-8 bg-slate-900 text-white rounded-lg flex items-center justify-center text-sm font-bold shadow-md shadow-slate-900/10 cursor-pointer" onClick={onToggle}>
            {isCollapsed ? 'â˜°' : 'ğŸ›ï¸'}
          </div>
          {!isCollapsed && (
            <div className="whitespace-nowrap overflow-hidden">
              <h1 className="font-bold text-slate-900 text-sm tracking-tight leading-tight">ç”µå•†æ™ºèƒ½åŠ©æ‰‹</h1>
            </div>
          )}
        </div>
        {!isCollapsed && (
          <button onClick={onToggle} className="p-1.5 rounded-md text-slate-400 hover:text-slate-600 hover:bg-slate-200/50 transition-colors">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
          </button>
        )}
      </div>

      {/* Primary Action */}
      <div className={`px-3 mb-4 transition-all duration-300 ${isCollapsed ? 'flex justify-center' : ''}`}>
        <button
          onClick={onNewChat}
          title="æ–°å»ºå¯¹è¯"
          className={`flex items-center justify-center gap-2 h-9 rounded-lg border border-slate-200 hover:border-slate-400 hover:text-slate-900 text-slate-500 bg-white hover:bg-white transition-all duration-200 group shadow-sm ${isCollapsed ? 'w-9 p-0' : 'w-full px-2'}`}
        >
           <div className={`flex items-center justify-center`}>
             <span className="text-xl leading-none pb-0.5 font-light">+</span>
           </div>
           {!isCollapsed && <span className="text-sm font-medium">æ–°å»ºå¯¹è¯</span>}
        </button>
      </div>

      <div className="flex-1 overflow-y-auto px-3 space-y-1 custom-scrollbar">
        {images.map((image: any) => {
          const agentType = image.name?.split("_")[0] || "guanhua";
          const agent = AGENTS_MAP[agentType] || AGENTS_UI[0];
          const isActive = image.imageId === currentImageId;

          return (
            <div
              key={image.imageId}
              onClick={() => onSelectImage(image.imageId)}
              title={isCollapsed ? agent.name : undefined}
              className={`group relative flex items-center gap-3 py-2 rounded-lg cursor-pointer transition-all duration-150 ${
                isCollapsed ? 'justify-center px-0' : 'px-3'
              } ${isActive ? "bg-blue-50/60 text-blue-900" : "text-slate-600 hover:bg-slate-100"}`}
            >
              {isActive && <div className="absolute left-0 top-1/2 -translate-y-1/2 w-0.5 h-4 bg-blue-500 rounded-r-full"></div>}
              <span className="text-lg shrink-0 opacity-90">{agent.icon}</span>
              {!isCollapsed && (
                <div className="flex-1 min-w-0 transition-opacity duration-200">
                  <div className={`text-sm truncate leading-snug ${isActive ? "font-medium" : "font-normal"}`}>
                    {agent.name}
                  </div>
                </div>
              )}
              {!isCollapsed && (
                <button
                  onClick={(e) => { e.stopPropagation(); onDeleteImage(image.imageId); }}
                  className="opacity-0 group-hover:opacity-100 p-1 text-slate-300 hover:text-rose-500 transition-colors"
                >
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
              )}
            </div>
          );
        })}
      </div>

      <div className={`p-4 border-t border-slate-100 shrink-0 transition-all duration-300 ${isCollapsed ? 'flex justify-center' : ''}`}>
        <button 
          className={`flex items-center gap-3 p-2 rounded-lg hover:bg-white hover:shadow-sm transition-all group ${isCollapsed ? 'justify-center w-auto' : 'w-full'}`} 
          onClick={onLogout}
          title={isCollapsed ? userId : undefined}
        >
          <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 text-xs font-bold border border-white shadow-sm shrink-0">
            {userId[0].toUpperCase()}
          </div>
          {!isCollapsed && (
            <>
              <div className="flex-1 text-left min-w-0"><div className="text-xs font-semibold text-slate-700 truncate">{userId}</div></div>
              <div className="text-slate-300 group-hover:text-slate-600">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
              </div>
            </>
          )}
        </button>
      </div>
    </div>
  );
}

// ============================================
// Mobile Components (WeChat Style)
// ============================================

function MobileTabBar({ activeTab, onTabChange }: any) {
  return (
    <div className="md:hidden fixed bottom-0 left-0 right-0 h-16 pb-safe bg-white/95 backdrop-blur border-t border-slate-200 flex items-center justify-around z-50 shadow-[0_-1px_10px_rgba(0,0,0,0.02)]">
      <button onClick={() => onTabChange("chats")} className={`flex flex-col items-center gap-1 w-full h-full pt-2 ${activeTab === 'chats' ? 'text-green-600' : 'text-slate-400'}`}>
        <svg width="24" height="24" viewBox="0 0 24 24" fill={activeTab === 'chats' ? "currentColor" : "none"} stroke="currentColor" strokeWidth={activeTab === 'chats' ? "0" : "2"}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <span className="text-[10px] font-medium">ä¼šè¯</span>
      </button>
      <button onClick={() => onTabChange("agents")} className={`flex flex-col items-center gap-1 w-full h-full pt-2 ${activeTab === 'agents' ? 'text-green-600' : 'text-slate-400'}`}>
        <svg width="24" height="24" viewBox="0 0 24 24" fill={activeTab === 'agents' ? "currentColor" : "none"} stroke="currentColor" strokeWidth={activeTab === 'agents' ? "0" : "2"}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
        <span className="text-[10px] font-medium">é€šè®¯å½•</span>
      </button>
      <button onClick={() => onTabChange("me")} className={`flex flex-col items-center gap-1 w-full h-full pt-2 ${activeTab === 'me' ? 'text-green-600' : 'text-slate-400'}`}>
        <svg width="24" height="24" viewBox="0 0 24 24" fill={activeTab === 'me' ? "currentColor" : "none"} stroke="currentColor" strokeWidth={activeTab === 'me' ? "0" : "2"}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        <span className="text-[10px] font-medium">æˆ‘</span>
      </button>
    </div>
  );
}

// ============================================
// Main Page
// ============================================

function MainPage({ userId, onLogout }: any) {
  const agentx = useAgentX(WS_URL);
  const { images, isLoading, createImage, deleteImage } = useImages(agentx, { containerId: userId, autoLoad: true });
  const [currentImageId, setCurrentImageId] = useState<string | null>(null);
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  
  // Mobile States
  const [mobileTab, setMobileTab] = useState<"chats" | "agents" | "me">("chats");

  useEffect(() => {
    // Only auto-select on desktop
    if (window.innerWidth >= 768 && !currentImageId && images.length > 0) setCurrentImageId(images[0].imageId);
  }, [images, currentImageId]);

  const currentImage = images.find((img: any) => img.imageId === currentImageId);
  const currentAgent = currentImage ? (AGENTS_MAP[currentImage.name?.split("_")[0]] || AGENTS_UI[0]) : AGENTS_UI[0];

  const handleCreateSession = async (agentId: string) => {
    const agent = AGENTS_MAP[agentId];
    if (!agent) return;
    const newImage = await createImage({
      name: `${agentId}_${Date.now()}`,
      description: `ä¸${agent.name}åä½œä¸­`,
      systemPrompt: agent.systemPrompt,
    });
    if (newImage?.imageId) {
      setCurrentImageId(newImage.imageId);
      // On mobile, switch to chats tab and enter chat automatically
      setMobileTab("chats"); 
    }
  };

  // Mobile Views
  const renderMobileView = () => {
    if (mobileTab === "agents") {
      return (
        <div className="p-4 pt-safe pb-safe bg-slate-50 min-h-screen-ios">
          <div className="h-12 flex items-center px-2 mb-2">
             <h2 className="text-lg font-bold text-slate-900">æ™ºèƒ½ä½“é€šè®¯å½•</h2>
          </div>
          <div className="space-y-3 pb-20">
            {AGENTS_UI.map(agent => (
              <div key={agent.id} onClick={() => handleCreateSession(agent.id)} className="bg-white p-4 rounded-xl flex items-center gap-4 shadow-sm active:bg-slate-50 border border-slate-100">
                 <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-2xl ${agent.theme.icon_bg} ${agent.theme.text}`}>{agent.icon}</div>
                 <div>
                   <h3 className="font-bold text-slate-900">{agent.name}</h3>
                   <p className="text-xs text-slate-500">{agent.description}</p>
                 </div>
              </div>
            ))}
          </div>
        </div>
      );
    }
    if (mobileTab === "me") {
      return (
        <div className="p-0 bg-slate-100 min-h-screen-ios pt-safe pb-safe">
          <div className="bg-white p-8 pb-10 flex items-center gap-4 mb-3 border-b border-slate-200 mt-12">
            <div className="w-16 h-16 rounded-lg bg-slate-200 flex items-center justify-center text-xl font-bold text-slate-500">{userId[0].toUpperCase()}</div>
            <div>
              <h2 className="text-xl font-bold">{userId}</h2>
              <p className="text-sm text-slate-500">ID: {userId}</p>
            </div>
          </div>
          <div className="bg-white border-y border-slate-200">
             <button onClick={onLogout} className="w-full p-4 text-center text-red-600 font-medium active:bg-slate-50">é€€å‡ºç™»å½•</button>
          </div>
        </div>
      );
    }
    // Default: Chats
    return (
      <div className="bg-white min-h-screen-ios pt-safe pb-safe flex flex-col">
         {/* Mobile Header - Safe Area Aware */}
         <div className="h-12 bg-slate-100/90 backdrop-blur border-b border-slate-200 flex items-center justify-center z-10 shrink-0 relative top-0 sticky">
           <span className="font-semibold text-slate-900">æ¶ˆæ¯ ({images.length})</span>
           <button onClick={() => setMobileTab("agents")} className="absolute right-4 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center bg-slate-200 rounded-full text-slate-600 active:bg-slate-300">
             <span className="text-lg leading-none mb-0.5">+</span>
           </button>
         </div>
         
         <div className="divide-y divide-slate-100 overflow-y-auto flex-1 pb-20">
           {images.map((image: any) => {
             const agent = AGENTS_MAP[image.name?.split("_")[0]] || AGENTS_UI[0];
             return (
               <div key={image.imageId} onClick={() => setCurrentImageId(image.imageId)} className="p-4 flex gap-3 active:bg-slate-50">
                  <div className={`w-12 h-12 rounded-lg flex items-center justify-center text-2xl shrink-0 ${agent.theme.icon_bg} ${agent.theme.text}`}>{agent.icon}</div>
                  <div className="flex-1 min-w-0">
                    <div className="flex justify-between items-baseline mb-1">
                      <h3 className="font-medium text-slate-900 truncate">{agent.name}</h3>
                      <span className="text-[10px] text-slate-400">åˆšåˆš</span>
                    </div>
                    <p className="text-xs text-slate-500 truncate">{image.description}</p>
                  </div>
               </div>
             )
           })}
           {images.length === 0 && (
             <div className="flex flex-col items-center justify-center h-64 text-center p-8">
               <div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-3xl mb-4 grayscale opacity-50">ğŸ“«</div>
               <p className="text-slate-400 text-sm">æš‚æ— æ¶ˆæ¯</p>
               <button onClick={() => setMobileTab("agents")} className="mt-4 text-blue-600 text-sm font-medium">å»é€šè®¯å½•å‘èµ·å¯¹è¯</button>
             </div>
           )}
         </div>
      </div>
    );
  };

  if (!agentx || isLoading) return <div className="h-screen w-full flex items-center justify-center bg-white"><div className="w-2 h-2 bg-slate-900 rounded-full animate-ping"/></div>;

  return (
    <div className="h-screen-ios w-full flex bg-white font-sans text-slate-900 selection:bg-blue-100 selection:text-blue-900 overflow-hidden">
      
      {/* ================= PC LAYOUT ================= */}
      <Sidebar 
        userId={userId} images={images} currentImageId={currentImageId}
        isCollapsed={isSidebarCollapsed} onToggle={() => setIsSidebarCollapsed(!isSidebarCollapsed)}
        onSelectImage={setCurrentImageId} onNewChat={() => setMobileTab("agents")} // On PC new chat redirects to agent list logic if needed, but here sidebar handles it differently
        onDeleteImage={(id: string) => { if(confirm("åˆ é™¤æ­¤å¯¹è¯?")) deleteImage(id); }}
        onLogout={onLogout}
      />
      
      {/* PC Main Content */}
      <div className="hidden md:flex flex-1 flex-col h-full relative bg-white min-w-0">
        <div className="flex-1 overflow-hidden relative">
          {currentImageId ? (
            <Chat 
              key={currentImageId} 
              agentx={agentx} 
              imageId={currentImageId} 
              agentName={currentAgent.name}
              placeholder={`å‘ ${currentAgent.name} å‘é€æŒ‡ä»¤...`}
              className="h-full relative z-10"
            />
          ) : (
            <div className="h-full flex flex-col items-center justify-center relative z-10 p-8">
              <div className="w-16 h-16 bg-slate-50 text-slate-300 rounded-2xl flex items-center justify-center text-3xl mb-6">âœ¨</div>
              <h2 className="text-xl font-bold text-slate-900 mb-2">å‡†å¤‡å°±ç»ª</h2>
              <p className="text-slate-500 text-sm mb-8 text-center max-w-xs">é€‰æ‹©å·¦ä¾§çš„å†å²å¯¹è¯ï¼Œæˆ–åˆ›å»ºä¸€ä¸ªæ–°çš„æ™ºèƒ½ä½“åä½œä¼šè¯ã€‚</p>
            </div>
          )}
        </div>
      </div>

      {/* ================= MOBILE LAYOUT ================= */}
      <div className="md:hidden flex-1 w-full bg-white relative h-full flex flex-col">
        {/* Mobile Tab Content */}
        {!currentImageId && renderMobileView()}
        
        {/* Mobile Tab Bar */}
        {!currentImageId && <MobileTabBar activeTab={mobileTab} onTabChange={setMobileTab} />}

        {/* Mobile Chat Interface (Full Screen Overlay) */}
        {currentImageId && (
          <div className="fixed inset-0 z-[60] bg-white flex flex-col animate-slide-in-right h-[100dvh]">
            <div className="h-12 pt-safe bg-slate-100/90 backdrop-blur flex items-center px-4 border-b border-slate-200 shrink-0 box-content">
              <button onClick={() => setCurrentImageId(null)} className="mr-4 text-slate-600 flex items-center active:text-slate-900">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                <span className="text-sm font-medium">è¿”å›</span>
              </button>
              <span className="font-bold text-slate-900 truncate flex-1 text-center pr-10">{currentAgent.name}</span>
              <button className="text-slate-600 w-8 flex justify-end"><span className="text-xl font-bold mb-2">...</span></button>
            </div>
            <div className="flex-1 overflow-hidden relative pb-safe">
              <Chat 
                key={currentImageId} 
                agentx={agentx} 
                imageId={currentImageId} 
                agentName={currentAgent.name}
                placeholder="å‘é€æ¶ˆæ¯..."
                className="h-full"
              />
            </div>
          </div>
        )}
      </div>

    </div>
  );
}

export default function App() {
  const [userId, setUserId] = useState<string | null>(localStorage.getItem("userId"));
  return userId ? <MainPage userId={userId} onLogout={() => { localStorage.removeItem("userId"); setUserId(null); }} /> : <LoginPage onLogin={setUserId} />;
}