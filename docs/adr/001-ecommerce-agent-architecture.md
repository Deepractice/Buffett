# ADR-001: 电商智能体架构设计

> 状态：草案
> 日期：2025-12-15
> 决策者：Sean, yejh0725

---

## 背景

电商商家面临的核心痛点：
1. **换图需求**：商品主图、详情图需要频繁更新，人工成本高
2. **内容发布**：小红书等平台的内容创作和发布繁琐耗时
3. **效率瓶颈**：视觉内容生产是电商运营的主要瓶颈

## 决策

### 架构设计

```
┌─────────────────────────────────────────────────────┐
│                   电商智能体                          │
│                 (EcommerceAgent)                     │
├─────────────────────────────────────────────────────┤
│  systemPrompt: 电商运营专家人设                       │
│  - 理解商家需求                                       │
│  - 调用工具完成任务                                   │
│  - 输出可执行结果                                     │
└─────────────────────────────────────────────────────┘
                          │
                          │ MCP 协议
                          ▼
┌─────────────────────────────────────────────────────┐
│                    MCP Servers                       │
├──────────────────────┬──────────────────────────────┤
│                      │                              │
│   promptx            │    xiaohongshu-mcp          │
│   (已有)              │    (待开发)                  │
│                      │                              │
│ ┌──────────────────┐ │ ┌──────────────────────────┐│
│ │ image-generator  │ │ │ 内容创作                  ││
│ │ - 图生图(换图)    │ │ │ 图片上传                  ││
│ │ - 文生图         │ │ │ 笔记发布                  ││
│ │ - 分步编辑       │ │ │ 数据查看                  ││
│ │ - 4K输出        │ │ └──────────────────────────┘│
│ └──────────────────┘ │                              │
│                      │                              │
│ ┌──────────────────┐ │                              │
│ │ prompt-assembler │ │                              │
│ │ - 提示词组装     │ │                              │
│ └──────────────────┘ │                              │
│                      │                              │
│ ┌──────────────────┐ │                              │
│ │ vision-analyzer  │ │                              │
│ │ - 图片分析       │ │                              │
│ └──────────────────┘ │                              │
│                      │                              │
│ ┌──────────────────┐ │                              │
│ │ filesystem       │ │                              │
│ │ - 文件读写       │ │                              │
│ └──────────────────┘ │                              │
│                      │                              │
└──────────────────────┴──────────────────────────────┘
```

### 核心工作流

#### 流程1：换图工作流

```
用户上传商品图
      │
      ▼
┌─────────────────┐
│ vision-analyzer │  分析原图：服装款式、颜色、材质
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ prompt-assembler│  组装提示词：基于分析结果+用户需求
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ image-generator │  生成新图：
│                 │  - mode: image_to_image
│                 │  - edit_scope: background_only / garment_only
│                 │  - candidateCount: 2-3
└────────┬────────┘
         │
         ▼
   输出多张候选图供选择
```

#### 流程2：小红书发布工作流（待实现）

```
商品图 + 卖点
      │
      ▼
┌─────────────────┐
│  内容创作       │  生成小红书风格文案
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  图片处理       │  调整尺寸、加水印
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  自动发布       │  通过浏览器自动化发布
└────────┬────────┘
         │
         ▼
   发布成功，返回链接
```

### 技术选型

| 组件 | 方案 | 理由 |
|-----|------|-----|
| 图像生成 | Gemini 3 Pro (via apiyi.com) | 已集成、效果好、支持4K |
| 智能体框架 | AgentX | 项目已采用、三包即用 |
| MCP协议 | PromptX | 工具生态完善 |
| 小红书发布 | 浏览器自动化(待定) | 无官方API，需自动化方案 |

### 前端设计：画板组件

#### 设计原则

从第一性原理出发，左侧区域的核心定位：
- **简单** - 就是一个画板，用于图片对比和预览
- **AI控制** - 内容由 AI 放入，不是用户手动操作
- **可伸缩** - 用户可拖拽调整宽度，也可完全收起

#### 布局架构

```
┌─────────────────────────────────────────────────────┐
│                    前端                              │
│                                                     │
│  ┌──────────────┬─────────────────────────────┐    │
│  │              │                             │    │
│  │    画板      │         AI 对话             │    │
│  │  (可收起)    │                             │    │
│  │              │    "帮我换个背景"            │    │
│  │  ┌───┐ ┌───┐│    "好的，已生成3张"         │    │
│  │  │原图│→│新图││     ← AI把图放到画板         │    │
│  │  └───┘ └───┘│                             │    │
│  │              │                             │    │
│  └──────────────┴─────────────────────────────┘    │
│        ↑ 可拖拽伸缩                                 │
└─────────────────────────────────────────────���───────┘
```

#### 技术选型

| 组件 | 方案 | 理由 |
|-----|------|-----|
| 图片对比 | [react-compare-slider](https://github.com/nerdyman/react-compare-slider) | 零依赖、支持任意React组件、27k周下载 |
| 分栏布局 | Allotment (已有) | 支持拖拽伸缩、可收起 |
| 画板扩展 | [tldraw](https://tldraw.dev/) (可选) | 如需更复杂的画板功能，支持AI程序化控制 |

#### 移动端适配

```
桌面端 (>768px)        移动端 (<768px)
┌────────┬────────┐    ┌────────────────┐
│  画板  │  对话  │    │ [画板] [对话]  │ ← Tab切换
└────────┴────────┘    ├────────────────┤
                       │   当前Tab内容   │
                       └────────────────┘
```

### 浏览器自动化设计

#### 核心原则

用户不需要知道 AI 在浏览器里做了什么，只关心结果。

```
用户："帮我发到小红书"
AI：  "已发布，链接：https://..."
      ↑ 后台静默执行，只返回结果
```

#### 技术方案

| 组件 | 方案 | 理由 |
|-----|------|-----|
| 浏览器自动化 | [browser-use](https://github.com/browser-use/browser-use) | 63k stars、支持MCP Server、AI原生控制 |
| 底层引擎 | Playwright | browser-use 底层依赖 |
| 部署方式 | 服务端无头浏览器 | 支持服务器部署，无需桌面端 |

### 分阶段实施

**Phase 1：换图能力（本期）**
- [x] image-generator 工具已就绪
- [ ] 创建 EcommerceAgent 角色
- [ ] 定义换图工作流 systemPrompt
- [ ] 实现画板组件（图片对比、可伸缩）
- [ ] 前端适配（上传图片、展示结果）

**Phase 2：小红书发布（下期）**
- [ ] 集成 browser-use MCP
- [ ] 开发小红书发布工作流
- [ ] 整合换图+发布流程

## 后果

### 优点
1. 复用已有 PromptX 工具生态，开发成本低
2. MCP 协议解耦，小红书 MCP 可独立开发
3. AgentX 框架成熟，快速上线

### 风险
1. 小红书无官方API，浏览器自动化可能不稳定
2. 图像生成质量依赖提示词，需要持续优化

### 缓解措施
1. 小红书 MCP 设计为可插拔，先做手动发布兜底
2. 积累电商场景提示词模板，形成 knowledge 资源

---

## 相关文档

- [开发者教程](../开发者教程.md)
- [PromptX image-generator 手册](tool://image-generator)
